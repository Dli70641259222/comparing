<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BOL vs Export Declaration Comparison</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    input, button { margin: 5px 0; }
  </style>
</head>
<body>
  <h2>Compare Bill of Lading and Export Declaration</h2>
  <p>Upload your PDF files:</p>
  <input type="file" id="bolFile" accept=".pdf">
  <input type="file" id="exportFile" accept=".pdf">
  <br>
  <button onclick="compareDocuments()">Compare</button>

  <table id="comparisonTable">
    <thead>
      <tr>
        <th>Field</th>
        <th>Bill of Lading</th>
        <th>Export Declaration</th>
        <th>Result</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.min.js"></script>
  <script>
    async function getTextFromPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
      let text = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(' ') + '\n';
      }
      return text;
    }

    function extractFieldsFromBOL(text) {
      // Basic regex patterns (adjust if needed)
      const fields = {};

      fields['Exporter Name'] = (text.match(/Exporter\s*[:\-]?\s*(.+)/i) || [])[1] || '';
      fields['Consignee'] = (text.match(/Consignee\s*[:\-]?\s*(.+)/i) || [])[1] || '';
      fields['Document Number'] = (text.match(/Document Number\s*[:\-]?\s*(\S+)/i) || [])[1] || '';
      fields['Destination'] = (text.match(/Destination\s*[:\-]?\s*(.+)/i) || [])[1] || '';
      fields['Vessel'] = (text.match(/Vessel\s*[:\-]?\s*(.+)/i) || [])[1] || '';
      fields['Container Number'] = (text.match(/([A-Z]{3}\d{7})/g) || []).join(', ') || '';
      fields['Total Weight'] = (text.match(/Gross Weight\s*[:\-]?\s*(\d+\.?\d*)/i) || [])[1] || '';
      fields['Transit Information'] = (text.match(/Transit\s*[:\-]?\s*(.+)/i) || [])[1] || '';
      fields['ECTN Number'] = (text.match(/ECTN\s*[:\-]?\s*(\S+)/i) || [])[1] || '';
      fields['CERS Number'] = (text.match(/CERS\s*[:\-]?\s*(\S+)/i) || [])[1] || '';

      // Extract car models and VINs
      const cars = [];
      const vins = text.match(/\b[A-HJ-NPR-Z0-9]{17}\b/g) || [];
      text.split('\n').forEach(line => {
        const carMatch = line.match(/([A-Za-z0-9\s]+)\s+VIN/i);
        if (carMatch) cars.push(carMatch[1].trim());
      });
      fields['Cars Model'] = cars.join(', ') || '';
      fields['VINs'] = vins.join(', ') || '';

      return fields;
    }

    function compareValues(bolValue, exportValue) {
      if (!exportValue) return 'Not Found';
      if (bolValue === exportValue) return 'Same';
      if (bolValue.toLowerCase().trim() === exportValue.toLowerCase().trim()) return 'Approximately';
      return 'Not the same';
    }

    async function compareDocuments() {
      const bolFile = document.getElementById('bolFile').files[0];
      const exportFile = document.getElementById('exportFile').files[0];

      if (!bolFile || !exportFile) {
        alert('Please upload both files!');
        return;
      }

      const bolText = await getTextFromPDF(bolFile);
      const exportText = await getTextFromPDF(exportFile);

      const bolFields = extractFieldsFromBOL(bolText);

      const tbody = document.querySelector('#comparisonTable tbody');
      tbody.innerHTML = '';

      for (const [field, bolValue] of Object.entries(bolFields)) {
        // Very simple matching: check if BOL value exists in export text
        let exportValue = '';
        if (bolValue) {
          const regexSafe = bolValue.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'); // escape regex
          const match = exportText.match(new RegExp(regexSafe, 'i'));
          exportValue = match ? match[0] : '';
        }

        const result = compareValues(bolValue, exportValue);

        const row = document.createElement('tr');
        row.innerHTML = `<td>${field}</td><td>${bolValue || '---'}</td><td>${exportValue || '---'}</td><td>${result}</td>`;
        tbody.appendChild(row);
      }
    }
  </script>
</body>
</html>
