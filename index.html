<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BOL & Export Declaration Compare</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f7f7f7; }
    .same { background: #d4edda; }
    .not-same { background: #f8d7da; }
    .approx { background: #fff3cd; }
    .not-found { background: #e2e3e5; }
  </style>
</head>
<body>
<h2>Upload Bill of Lading and Export Declaration PDFs</h2>
<input type="file" id="bolFile" accept="application/pdf">
<input type="file" id="expFile" accept="application/pdf">
<button onclick="compareDocs()">Compare</button>

<div id="output"></div>

<script>
let pdfjsLib = window['pdfjs-dist/build/pdf'];

async function extractTextFromPDF(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let fullText = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const txt = await page.getTextContent();
    fullText += txt.items.map(item => item.str).join(' ') + "\n";
  }
  return fullText;
}

// Dummy field extractors: Adjust regex and logic based on your real PDFs!
function extractFields(text) {
  return {
    exporter: /Exporter.*?:\s*([^\n]+)/i.exec(text)?.[1] || "",
    consignee: /Consignee.*?:\s*([^\n]+)/i.exec(text)?.[1] || "",
    docNum: /Document Number.*?:\s*([^\n]+)/i.exec(text)?.[1] || /No(?:\.|:)?\s*(\d+)/i.exec(text)?.[1] || "",
    dest: /Destination.*?:\s*([^\n]+)/i.exec(text)?.[1] || "",
    vessel: /Vessel.*?:\s*([^\n]+)/i.exec(text)?.[1] || "",
    container: /(CNT|Container).*?:\s*([^\n]+)/i.exec(text)?.[2] || "",
    weight: /Weight.*?:\s*([^\n]+)/i.exec(text)?.[1] || /Gross weight.*?(\d+[\.,]?\d*)\s*Kg/i.exec(text)?.[1] || "",
    transit: /TRANSIT.*?([^\n]+)/i.exec(text)?.[1] || "",
    ectn: /ECTN.*?:\s*([^\n]+)/i.exec(text)?.[1] || "",
    cers: /CERS.*?:\s*([^\n]+)/i.exec(text)?.[1] || "",
    models: /(?:Model|Car Model|Description).*?:\s*([^\n]+)/i.exec(text)?.[1] || "",
    vins: /VIN.*?:?\s*([\w\d\s,]+)/i.exec(text)?.[1] || "",
  };
}

function compare(a, b) {
  if (!a && !b) return ['not-found', 'Not found'];
  if (a.trim() === b.trim()) return ['same', 'Same'];
  if (!a || !b) return ['not-found', 'Not found'];
  if (a.trim().toLowerCase() === b.trim().toLowerCase()) return ['same', 'Same'];
  if (a && b && (a.includes(b) || b.includes(a))) return ['approx', 'Approximately'];
  return ['not-same', 'Not the same'];
}

async function compareDocs() {
  const bolFile = document.getElementById('bolFile').files[0];
  const expFile = document.getElementById('expFile').files[0];
  if (!bolFile || !expFile) {
    alert('Please upload both PDFs.');
    return;
  }
  document.getElementById('output').innerText = 'Extracting...';

  const bolText = await extractTextFromPDF(bolFile);
  const expText = await extractTextFromPDF(expFile);

  const fields = [
    { label: 'Exporter Name', key: 'exporter' },
    { label: 'Consignee', key: 'consignee' },
    { label: 'Document Number', key: 'docNum' },
    { label: 'Destination', key: 'dest' },
    { label: 'Vessel', key: 'vessel' },
    { label: 'Container Number', key: 'container' },
    { label: 'Total Weight', key: 'weight' },
    { label: 'Transit Information', key: 'transit' },
    { label: 'ECTN Number', key: 'ectn' },
    { label: 'CERS Number', key: 'cers' },
    { label: 'Car Models', key: 'models' },
    { label: 'VINs for Cars', key: 'vins' },
  ];

  const bolFields = extractFields(bolText);
  const expFields = extractFields(expText);

  let table = `<table><thead><tr>
      <th>Field</th>
      <th>Bill of Lading</th>
      <th>Export Declaration</th>
      <th>Result</th>
      </tr></thead><tbody>`;

  fields.forEach(f => {
    let [cls, txt] = compare(bolFields[f.key], expFields[f.key]);
    table += `<tr>
        <td>${f.label}</td>
        <td>${bolFields[f.key] || ''}</td>
        <td>${expFields[f.key] || ''}</td>
        <td class="${cls}">${txt}</td>
      </tr>`;
  });
  table += `</tbody></table>`;
  document.getElementById('output').innerHTML = table;
}
</script>
</body>
</html>
