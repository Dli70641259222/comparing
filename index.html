<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Compare Export Declaration Using Bill of Lading</title>
<style>
  body { font-family: Arial, sans-serif; margin: 30px; background: #fafafa; }
  h2 { color: #333; }
  input { margin: 10px 0; }
  button { padding: 8px 16px; cursor: pointer; background: #005bbb; color: white; border: none; border-radius: 4px; }
  button:hover { background: #004699; }
  table { width: 100%; border-collapse: collapse; margin-top: 25px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
  th { background: #f0f0f0; }
  .same { color: green; font-weight: bold; }
  .approx { color: orange; font-weight: bold; }
  .diff { color: red; font-weight: bold; }
  #summary { margin-top: 15px; font-weight: bold; }
</style>
</head>
<body>

<h2>üì¶ Compare Export Declaration (Using Bill of Lading as Reference)</h2>

<label>Upload Bill of Lading (PDF):</label><br>
<input type="file" id="pdf1" accept="application/pdf"><br>
<label>Upload Export Declaration (PDF):</label><br>
<input type="file" id="pdf2" accept="application/pdf"><br>

<button onclick="comparePDFs()">Compare</button>

<div id="result"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
async function extractText(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let text = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    const strings = content.items.map(item => item.str);
    text += strings.join(" ") + "\n";
  }
  return text;
}

function normalize(t) { return t ? t.replace(/\s+/g, " ").trim() : ""; }

function compareText(label, refValue, declText) {
  if (!refValue) return `<tr><td>${label}</td><td>-</td><td>-</td><td class='diff'>‚ùå Not Found</td></tr>`;
  const val = refValue.toLowerCase();
  const text = declText.toLowerCase();
  let res = "‚ùå Not Found", cls = "diff";
  if (text.includes(val)) { res = "‚úÖ Same"; cls = "same"; }
  else if (val.split(" ").filter(v => v.length > 3).some(v => text.includes(v))) { res = "‚ö†Ô∏è Approximately"; cls = "approx"; }
  return `<tr><td>${label}</td><td>${refValue}</td><td>${res==='‚ùå Not Found' ? '-' : 'Found in Export Declaration'}</td><td class='${cls}'>${res}</td></tr>`;
}

function compareWeight(label, refValue, declText) {
  if (!refValue) return `<tr><td>${label}</td><td>-</td><td>-</td><td class='diff'>‚ùå Not Found</td></tr>`;
  const refNum = parseFloat(refValue.replace(/,/g,''));
  const numbers = declText.match(/\d{1,3}(?:,\d{3})*(?:\.\d{1,2})?/g) || [];
  let res='‚ùå Not Found', cls='diff';
  for(const n of numbers){
    const num = parseFloat(n.replace(/,/g,''));
    if(num === refNum){ res='‚úÖ Same'; cls='same'; break; }
    else if(Math.abs(num - refNum)/refNum < 0.05){ res='‚ö†Ô∏è Approximately'; cls='approx'; break; }
  }
  return `<tr><td>${label}</td><td>${refValue}</td><td>${res==='‚ùå Not Found' ? '-' : 'Found in Export Declaration'}</td><td class='${cls}'>${res}</td></tr>`;
}

async function comparePDFs() {
  const f1 = document.getElementById("pdf1").files[0];
  const f2 = document.getElementById("pdf2").files[0];
  const res = document.getElementById("result");
  if (!f1 || !f2) { res.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Please upload both files.</p>"; return; }
  res.innerHTML = "‚è≥ Reading and comparing...";

  const [bolText, declText] = await Promise.all([extractText(f1), extractText(f2)]);
  const t1 = bolText.replace(/\s+/g, " ");
  const t2 = declText.replace(/\s+/g, " ");

  // Extract values dynamically from BOL
  const ref = {
    exporter: (t1.match(/Exporter[:\s]*(.+?)(?=Consignee|Document|$)/i) || ["",""])[1].trim(),
    document: (t1.match(/\b\d{7,8}\b/) || [""])[0],
    consignee: (t1.match(/Consignee[:\s]*(.+?)(?=Document|Container|$)/i) || ["",""])[1].trim(),
    carrier_foreign_port_unloading: (t1.match(/Carrier[:\s]*(.+?)Port of Loading[:\s]*(.+?)Port of Discharge[:\s]*(.+?)(?=\bDocument|\bContainer|$)/i) || ["","","",""])[1]+" / "+(t1.match(/Carrier[:\s]*(.+?)Port of Loading[:\s]*(.+?)Port of Discharge[:\s]*(.+?)(?=\bDocument|\bContainer|$)/i) || ["","","",""])[2]+" / "+(t1.match(/Carrier[:\s]*(.+?)Port of Loading[:\s]*(.+?)Port of Discharge[:\s]*(.+?)(?=\bDocument|\bContainer|$)/i) || ["","","",""])[3],
    container: (t1.match(/([A-Z]{4}\d{7})/i) || [""])[0],
    cars: (t1.match(/([A-Z0-9]+)\s*VIN[:\s]*([A-Z0-9]{17})/gi) || []).join("<br>"),
    gross: (t1.match(/(\d{1,3}(?:,\d{3})*\.\d{1,2})\s*Kg/i) || [""])[0],
    ectn: (t1.match(/ECTN[:\s]*(\S+)/i) || ["",""])[1],
    in_transit: (t1.match(/In Transit[:\s]*(\S+)/i) || ["",""])[1]
  };

  // Build table
  let html = `<h3>üìã Comparison Results</h3>
  <table>
  <tr><th>Field</th><th>Bill of Lading</th><th>Export Declaration</th><th>Result</th></tr>`;
  
  html += compareText("Exporter", ref.exporter, t2);
  html += compareText("Document Number", ref.document, t2);
  html += compareText("Consignee", ref.consignee, t2);
  html += compareText("Carrier / Foreign Port / Unloading Port", ref.carrier_foreign_port_unloading, t2);
  html += compareText("Container Number", ref.container, t2);
  html += compareText("Cars (Model + VIN)", ref.cars, t2);
  html += compareWeight("Gross Weight", ref.gross, t2);
  html += compareText("ECTN", ref.ectn, t2);
  html += compareText("In Transit", ref.in_transit, t2);
  
  html += "</table>";

  const same = (html.match(/‚úÖ/g) || []).length;
  const approx = (html.match(/‚ö†Ô∏è/g) || []).length;
  const diff = (html.match(/‚ùå/g) || []).length;
  html += `<div id="summary">Summary: ‚úÖ Same = ${same}, ‚ö†Ô∏è Approximately = ${approx}, ‚ùå Not Found / Not Same = ${diff}</div>`;

  res.innerHTML = html;
}
</script>
</body>
</html>
